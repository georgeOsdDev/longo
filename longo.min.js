/*!
 * longo
 * https://github.com/georgeOsdDev/Longo
 *
 * The MIT License (MIT)
 * Copyright (c) 2014 Takeharu Oshida <georgeosddev@gmail.com>
 */

!function(a){"use strict";function b(){this.dom=window.document.createDocumentFragment()}function c(a,b,c){this.name=a,this.opt=b,this.db=c,this.cbs={},this.logger=j("Longo."+c.name+"."+a);var d=this.worker=new Worker(g+"/longoCollectionWorker.js");d.addEventListener("message",this.onMessage,!1),d.addEventListener("error",this.onError,!1),this.status=k.CREATED}function d(){var a=h.apply(arguments);a[0]instanceof d?(this.criteria=a[0].criteria,this.projection=a[0].projection,this.collection=a[0].collection,this.cmdChain=a[0].cmdChain):(this.criteria=a[0]||{},this.projection=a[1]||{},this.collection=a[2],this.cmdChain=[])}function e(a){this.name=a,this.workers={},this.lastError=null,this.logger=j("Longo."+a)}var f="0.1.0",g="/Longo.js";!function(){for(var a=document.getElementsByTagName("script"),b=a.length;b--;){var c=a[b].src.match(/(^|.*)\/longo\.js$/);if(c){g=c[1];break}}}();{var h,i,j,k={CREATED:0,STARTED:1,STOPPED:2,DELETED:3},l={1:{cd:1,name:"UnknownError",message:"Unknown error occured",isFatal:!0},101:{cd:101,name:"CollectionNotFound",message:"Collection is not found %s",isFatal:!0},102:{cd:102,name:"CollectionNotInitialized",message:"Collection is not initialized %s",isFatal:!0},103:{cd:103,name:"CollectionStopped",message:"Collection is stopped %s",isFatal:!0}};_.invert(l)}h=Array.prototype.slice,i=function(a,b){a.super_=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})},j=function(a){var b={log:function(){},error:function(){}};return console?(b.log=function(){console.log.bind(console,a)}(),b.error=function(){console.error.bind(console,a)}(),b):b},b.prototype.addEventListener=function(){this.dom.addEventListener.apply(this.dom,h.apply(arguments))},b.prototype.removeEventListener=function(){this.dom.removeEventListener.apply(this.dom,h.apply(arguments))},b.prototype.dispatchEvent=function(){var a=h.apply(arguments),b=a[0];b&&(a[0]="Event"===b.constructor.name?a[0]:new CustomEvent(a[0].toString(),a[1]),this.dom.dispatchEvent.apply(this.dom,a))},b.prototype.on=b.prototype.addEventListener,b.prototype.bind=b.prototype.addEventListener,b.prototype.off=b.prototype.removeEventListener,b.prototype.unbind=b.prototype.removeEventListener,b.prototype.emit=b.prototype.dispatchEvent,b.prototype.trigger=b.prototype.dispatchEvent,i(c,b),c.prototype.onMessage=function(a){var b=a.data||{},c=b.seq||-1,d=b.error||null;d&&(this.db.lastError=d),"function"==typeof this.cbs[c]&&this.cbs[c](d,b.result)},c.prototype.onError=function(a){this.db.lastError=a,this.db.emit("error",a),this.emit("error",a),this.logger.error(["ERROR: Line ",a.lineno," in ",a.filename,": ",a.message].join(""))},c.prototype.initialize=function(a){this.send({cmd:"start",name:this.name,opt:this.opt,db:_.isArray(a)?a:[]},function(){self.status=k.STARTED})},c.prototype.getNextSeq=function(){var a=0,b=function(){return a++,a};return this.getNextSeq=b,a},c.prototype.send=function(a,b){if(this.status===k.DELETED)return b(l[101]);if(this.status===k.CREATED)return b(l[102]);if(this.status===k.STOPPED)return b(l[103]);var c=this.getNextSeq();return this.cbs[c]=b,a.seq=c,this.worker.postMessage(a),this.name+":"+c},c.prototype.findAll=function(a,b){return this.send({cmd:"find",criteria:{},projection:a},b)},c.prototype.find=function(a,b,c){return this.send({cmd:"find",criteria:a,projection:b},c)},c.prototype.save=function(a,b){return this.send({cmd:"save",doc:a},b)},c.prototype.cursor=function(a,b){return new d(a,b,this)},c.prototype.drop=function(a){var b=this,c=function(){delete b.db.workers[b.name],"function"==typeof a&&a()};return this.send({cmd:"drop"},c)},d.prototype.done=function(a){var b={cmd:"find",criteria:this.criteria,projection:this.projection,cmdChain:this.cmdChain};return this.collection.send(b,a)},d.prototype.count=function(a){return this.cmdChain.push({cmd:"count",args:a}),this},d.prototype.forEach=function(){return this.cmdChain.push({cmd:"forEach",args:h.apply(arguments)}),this},d.prototype.limit=function(a){return this.cmdChain.push({cmd:"limit",args:a}),this},d.prototype.map=function(){return this.cmdChain.push({cmd:"map",args:h.apply(arguments)}),this},d.prototype.max=function(){return this.cmdChain.push({cmd:"max",args:null}),this},d.prototype.min=function(){return this.cmdChain.push({cmd:"min",args:null}),this},d.prototype.size=function(){return this.cmdChain.push({cmd:"size",args:null}),this},d.prototype.skip=function(a){return this.cmdChain.push({cmd:"skip",args:a}),this},d.prototype.sort=function(a){return this.cmdChain.push({cmd:"sort",args:a}),this},i(e,b),e.getVersion=function(){return f},e.ERROR_CDS=l,e.STATUS_CDS=k,e.prototype.getCollectionNames=function(){return _.keys(this.workers)},e.prototype.getCollection=function(){return this.workers[cname]},e.prototype.collection=function(a){var b=a+"";if(b||(b="temp"),this.workers[b])return this.workers[b];var d=new c(b,{capped:!1},this);return d.initialize([]),this.workers[b]=d,d},e.prototype.createCollection=e.prototype.collection,e.prototype.dropDatabase=function(){_.each(_.values(this.workers),function(a){a.drop()})},e.prototype.getLastError=function(){return this.lastError},e.prototype.cloneCollection=function(a,b){if(!this.workers[b]&&!this.workers[a]){var d=new c(cname,this);d.initialize([])}},e.prototype.killOp=function(a){var b=a.split[":"];this.workers[b[0]]&&delete this.workers[b[0]].cbs[[1]]},a.Longo=e}(window);
//# sourceMappingURL=longo.min.map