<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>longoCollectionWorker.js - LONGO API</title>
    <link rel="stylesheet" href="http://yui.yahooapis.com/3.9.1/build/cssgrids/cssgrids-min.css">
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="http://yui.yahooapis.com/combo?3.9.1/build/yui/yui-min.js"></script>
</head>
<body class="yui3-skin-sam">

<div id="doc">
    <div id="hd" class="yui3-g header">
        <div class="yui3-u-3-4">
            
                <h1><img src="../assets/css/logo.png" title="LONGO API"></h1>
            
        </div>
        <div class="yui3-u-1-4 version">
            <em>API Docs for: 0.1.0</em>
        </div>
    </div>
    <div id="bd" class="yui3-g">

        <div class="yui3-u-1-4">
            <div id="docs-sidebar" class="sidebar apidocs">
                <div id="api-list">
    <h2 class="off-left">APIs</h2>
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">Classes</a></li>
            <li><a href="#api-modules">Modules</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="Type to filter APIs">
        </div>

        <div id="api-tabview-panel">
            <ul id="api-classes" class="apis classes">
            
            </ul>

            <ul id="api-modules" class="apis modules">
            
            </ul>
        </div>
    </div>
</div>

            </div>
        </div>
        <div class="yui3-u-3-4">
                <div id="api-options">
        Show:
        <label for="api-show-inherited">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </div>


            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <h1 class="file-heading">File: longoCollectionWorker.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/*!
 * longo
 * https://github.com/georgeOsdDev/Longo
 *
 * The MIT License (MIT)
 * Copyright (c) 2014 Takeharu Oshida &lt;georgeosddev@gmail.com&gt;
 */
importScripts(&#x27;./lib/underscore/underscore.js&#x27;);

function ObjectId(){
  this.val = Date.now();
}


var db = [];
self.addEventListener(&#x27;message&#x27;, function(e) {
  var data   = e.data   || {},
      cmd    = data.cmd || &#x27;unknown&#x27;,
      seq    = data.seq || -1,
      result = []
      ;

  switch (cmd) {

    case &#x27;start&#x27;:
      self.Logger = {};
      self.Logger.log = function(msg){console.log(&quot;Longo.&quot; + data.name + &quot;: &quot;+ msg);};
      self.Logger.error = function(msg){console.error(&quot;Longo.&quot; + data.name + &quot;: &quot;+ msg);};
      self.Logger.log(&quot;start&quot;);

      self.postMessage({&quot;seq&quot;:seq, &quot;errCd&quot;:0});
      break;

    case &#x27;drop&#x27;:
      self.db = null;
      self.postMessage({&quot;seq&quot;:seq, &quot;errCd&quot;:0});
      self.close(); // Terminates the worker.
      break;

    case &#x27;findAll&#x27;:
      result = project(self.db, data.projection);
      self.postMessage({&quot;seq&quot;:seq, &quot;errCd&quot;:0, &quot;result&quot;:result});
      break;

    case &#x27;save&#x27;:
      if (!data.doc[&quot;_id&quot;]) data.doc[&quot;_id&quot;] = new ObjectId();
      self.db.push(data.doc);
      self.postMessage({&quot;seq&quot;:seq, &quot;errCd&quot;:0, &quot;result&quot;:data.doc});
      break;

    case &#x27;removeAll&#x27;:
      self.db = [];
      self.postMessage({&quot;seq&quot;:seq, &quot;errCd&quot;:0, &quot;result&quot;:[]});
      break;

    default:
      self.postMessage({&quot;seq&quot;:seq, &quot;errCd&quot;:1, &quot;result&quot;:cmd + &quot; is not supported.&quot;});
  }
}, false);


function noop(){
  return void 0;
}
function asNoop(){
  return noop;
}

function aSlice(obj){
  return Array.prototype.slice.apply(obj);
}

function isArray(obj){
  return Array.isArray ? Array.isArray(obj) : (toString.call(obj) === &quot;[object Array]&quot;);
}

function toArray(obj) {
  return isArray(obj) ? obj : [obj];
}

function existy(val){
  return val !== null &amp;&amp; val !== undefined;
}

function truthy(val){
  return (val !== false) &amp;&amp; existy(val);
}

function isTrue(val){
  return val === true;
}

function isFalse(val){
  return val === false;
}

function isNegativeNum(val){
  return !truthy(val) || (_.isNumber(val) &amp;&amp; val &lt; 0);
}

function isZero(val){
  return val === 0;
}

function isOne(val){
  return val === 1;
}

function isPositiveNum(val){
  return !isNegative(val) &amp;&amp; !isZero(val);
}

function doWhen(cond, action, values, context) {
  var arr = toArray(values);
  if(truthy(cond))
    return action.apply(context, arr);
  else
    return undefined;
}

function doWhenOrElse(cond, action, alternative, values, context) {
  var arr = toArray(values);
  if(truthy(cond))
    return action.apply(context, arr);
  else
    return alternative.apply(context, arr);
}

// http://stackoverflow.com/questions/1248302/javascript-object-size
function roughSizeOfObject( object ) {
  var objectList = [];
  var stack = [ object ];
  var bytes = 0;

  while ( stack.length ) {
    var value = stack.pop();
    if ( typeof value === &#x27;boolean&#x27;){
      bytes += 4;
    } else if (typeof value === &#x27;string&#x27;){
      bytes += value.length * 2;
    } else if (typeof value === &#x27;number&#x27;){
      bytes += 8;
    } else if (typeof value === &#x27;object&#x27; &amp;&amp; objectList.indexOf( value ) === -1){
      objectList.push(value);
      for (var i in value) {
        stack.push(value[ i ]);
      }
    }
  }
  return bytes;
}


/**
 * http://docs.mongodb.org/manual/reference/method/db.collection.find/#definition
 *
 * The projection parameter takes a document of the following form:
 * { field1: &lt;boolean&gt;, field2: &lt;boolean&gt; ... }
 * The &lt;boolean&gt; value can be any of the following:

 * - 1 or true to include the field.
 * The find() method always includes the _id field
 * even if the field is not explicitly stated to return in the projection parameter.
 *
 * - 0 or false to exclude the field.
 * A projection cannot contain both include and exclude specifications, except for the exclusion of the _id field.
 * In projections that explicitly include fields, the _id field is the only field that you can explicitly exclude.
 */
function project(data, projection){
  var pairs     = _.pairs(projection),
      includes  = _.filter(pairs, function(p){return isOne(p[1])  || isTrue(p[1]);}),
      excludes  = _.filter(pairs, function(p){return isZero(p[1]) || isFalse(p[1]);}),
      keys
      ;

  if (_.size(includes) &gt; 0) {
    keys = _.pluck(includes, &quot;0&quot;);
    if (isZero(projection[&quot;_id&quot;]) || isFalse(projection[&quot;_id&quot;])){
      keys = _.without(keys, &quot;_id&quot;);
    } else {
      keys = _.union(keys, [&quot;_id&quot;]);
    }
    return _.map(data, function(d){return _.pick(d, keys);});
  } else {
    keys = _.pluck(excludes, &quot;0&quot;);
    return _.map(data, function(d){return _.omit(d, keys);});
  }
}



    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
