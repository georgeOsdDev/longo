/*
 * longo v-0.2.0
 * Source code can be found at https://github.com/georgeosddev/longo
 *
 * The MIT License (MIT)
 * Copyright (c) 2014 Takeharu Oshida <georgeosddev@gmail.com>
 */

var Longo,_;"undefined"!=typeof importScripts?importScripts("./lib/underscore/underscore-min.js","./lib/underscore-query/lib/underscore-query.min.js","./longo.min.js"):(_=require("underscore"),require("underscore-query")(_),Longo=require("./longo.js")),function(a,b,c,d){"use strict";var e="undefined"!=typeof console?console:{},f=function(a,b){var c=b||"log",f={msg:a,workerName:g.name};typeof e!==d&&e[c]&&e[c].call(e,JSON.stringify(f))},g={},h=b.Utils,i="SKIP_REST",j=["$inc","$mul","$rename","$setOnInsert","$set","$unset","$min","$max","$currentDate","$invert"],k={};k.dataset=[],k.option={capped:!1},k.isUpdatedBySeq={},g.getDataset=function(a){var b=a||k;return b.dataset},g.setDataset=function(a,b){var c=b||k;c.dataset=a},g.applyOperator=function(a,b){var d,e=c.identity(b),f=c.keys(a);return c.each(f,function(f){switch(d=a[f],f){case"$inc":c.each(c.keys(d),function(a){c.isNumber(b[a])&&c.isNumber(d[a])&&(e[a]=b[a]+d[a])});break;case"$mul":c.each(c.keys(d),function(a){c.isNumber(b[a])&&c.isNumber(d[a])&&(e[a]=b[a]*d[a])});break;case"$rename":c.each(c.keys(d),function(a){c.has(b,a)&&(e[d[a]]=b[a])});break;case"$set":c.each(c.keys(d),function(a){c.has(b,a)&&(e[a]=d[a])});break;case"$unset":c.each(c.keys(d),function(a){c.has(b,a)&&delete e[a]});break;case"$mod":c.each(c.keys(d),function(a){c.isNumber(b[a])&&c.isNumber(d[a])&&(e[a]=b[a]%d[a])})}}),e},g.parseDotQuery=function(a,b){var d,e,f,h;return b.indexOf(".")>0?(d=b.split("."),f=c.last(d),e=c.initial(d).join("."),h={},h[f]=a,g.parseDotQuery({$elemMatch:h},e)):[a,b]},g.toQuery=function(a){var b=h.checkOrElse(a,{},function(a){return c.isObject(a)}),d={};return c.each(b,function(a,b){if(c.contains(b,".")){var e=g.parseDotQuery(a,b),f={};f[b]=a,f[e[1]]=e[0],d.$or=f}else d[b]=a}),d},g.toDocument=function(a){if(c.isObject(a)&&!c.isArray(a))return a;var b=h.toArray(a),d=c.keys(b);return c.object(d,b)},g.isSizeReached=function(a,b,c){var d=c||1048576,e=h.str2ab(JSON.stringify(a)).byteLength,f=h.str2ab(JSON.stringify(b)).byteLength;return e+f>d},g.isCountReached=function(a,b){return c.size(a)+1>(b||1e3)},g.doStart=function(a,b,c){var d=c||k;return d.name=a.name,d.option=a.option,d.dataset=a.dataset,d.isUpdatedBySeq||(d.isUpdatedBySeq={}),d.isUpdatedBySeq[b]=!0,f("Longo Collection Worker Started","info"),[null,[]]},g.doFind=function(a,b){var d=g.toQuery(b);return[null,c.query(a,d)]},g.doInsert=function(a,d,e){var l=e||k;if(h.isZero(c.size(a)))return[i,null];l.dataset||(l.dataset=[]);var m=c.omit(g.toDocument(c.first(h.toArray(a))),j);if(m._id){if(c.where(l.dataset,{_id:m._id}).length>0)return[new b.Error(b.Error.DUPLICATE_KEY_ERROR,"_id: "+m._id),m]}else m._id=h.objectId();if(l.option.capped){if(g.isSizeReached(l.dataset,m,l.option.size))return f("Reached to size count for capped Collection. Size: "+l.option.size,"warn"),l.dataset.shift(),0===l.dataset.length?[i,null]:g.doInsert(a,d,l);g.isCountReached(l.dataset,l.option.max)&&(f("Reached to max count for capped Collection. Count: "+l.option.max,"warn"),l.dataset.shift())}return l.dataset.push(m),l.isUpdatedBySeq[d]=!0,g.doInsert(c.rest(a),d,l)},g.updateById=function(a,d,e,f){var h=f||k;if(d=g.toDocument(d),d._id&&a._id!==d._id)return[new b.Error(b.Error.MOD_ID_NOT_ALLOWED,"_id: "+d._id),null];var i=c.pick(d,j),l=c.omit(d,j);if(c.size(i)>0){if(c.size(l)>0)return[new b.Error(b.Error.INVALID_MODIFIER_SPECIFIED,l[0]),null];d=g.applyOperator(d,a)}return d._id=a._id,h.dataset=c.reject(h.dataset,function(b){return b._id===a._id}).concat([d]),h.isUpdatedBySeq[e]=!0,[null,null]},g.doUpdate=function(a,d,e,f,i){var j,l,m=i||k;if(j=g.doFind(m.dataset,a)[1],h.isZero(c.size(j)))return e.upsert?g.doInsert(d,f,m):[new b.Error(b.Error.DOCUMENT_NOT_FOUND,"query: "+JSON.stringify(a)),null];if(h.isOne(c.size(j)))return l=j[0],g.updateById(l,d,f,m);if(!e.multi)return g.updateById(j[0],d,f,m);if(d._id&&l._id!==d._id)return[new b.Error(b.Error.MOD_ID_NOT_ALLOWED,"_id: "+d._id),null];var n=[null,null];return c.every(j,function(a){return n=g.updateById(a,d,f,m),null===n[0]}),n},g.doSave=function(a,b,d){var e,f,j=d||k;if(a=h.toArray(a),h.isZero(c.size(a)))return[i,null];if(e=c.first(a),e._id){if(f=g.doUpdate({_id:e._id},e,{upsert:!0},b,j),f[0]&&f[0]!==i)return f}else f=g.doInsert(e,b,j);return g.doSave(c.rest(a),b,j)},g.doRemove=function(a,d,e,f){var i,j=f||k,l=g.doFind(j.dataset,a)[1];return h.isZero(c.size(l))?[new b.Error(b.Error.DOCUMENT_NOT_FOUND,"query: "+JSON.stringify(a)),null]:(d?j.dataset=c.reject(j.dataset,function(a){return a._id===l[0]._id}):(i=c.pluck(l,"_id"),j.dataset=c.reject(j.dataset,function(a){return c.contains(i,a._id)})),j.isUpdatedBySeq[e]=!0,[null,null])},g.doProject=function(a,b){var d,e=c.pairs(b),f=c.filter(e,function(a){return h.isOne(a[1])||h.isTrue(a[1])}),g=c.filter(e,function(a){return h.isZero(a[1])||h.isFalse(a[1])});return c.size(f)>0?(d=c.pluck(f,"0"),d=h.isZero(b._id)||h.isFalse(b._id)?c.without(d,"_id"):c.union(d,["_id"]),[null,c.map(a,function(a){return c.pick(a,d)})]):(d=c.pluck(g,"0"),[null,c.map(a,function(a){return c.omit(a,d)})])},g.doLimit=function(a,b){return[null,c.first(a,b)]},g.doSkip=function(a,b){return[null,c.rest(a,b)]},g.doCount=function(a){return[i,[c.size(a)]]},g.doSize=function(a){return[i,[h.str2ab(JSON.stringify(a)).byteLength]]},g.doToArray=function(a){return[null,h.toArray(a)]},g.doMax=function(a,b){var d,e,f;return d=c.keys(b),e=c.values(b,function(a){return{$lte:a}}),f=c.object(d,e),g.doFind(a,f)},g.doMin=function(a,b){var d,e,f;return d=c.keys(b),e=c.values(b,function(a){return{$gte:a}}),f=c.object(d,e),g.doFind(a,f)},g.doForEach=function(a,d){if(!d)return[null,a];var e=new Function(d+"")();try{return[null,c.forEach(a,e)]}catch(f){return[new b.Error(b.Error.EVAL_ERROR,"function: "+d,f.stack),null]}},g.doMap=function(a,d){if(!d)return[null,a];var e=new Function(d+"")();try{return[null,c.map(a,e)]}catch(f){return[new b.Error(b.Error.EVAL_ERROR,"function: "+d,f.stack),null]}},g.doSort=function(a,d){var e;if(!c.isString(d)){var f=c.keys(d)[0],g=d[f];return e=c.sortBy(a,f),c.isEmpty(c.last(e))&&(e=c.initial(e)),h.isOne(g)?[null,e]:[null,e.reverse()]}var i=new Function(d+"")();try{return e=c.sortBy(a,i),c.isEmpty(c.last(e))&&(e=c.initial(e)),[null,e]}catch(j){return[new b.Error(b.Error.EVAL_ERROR,"sorter: "+d,j.stack),null]}},g.getExecuter=function(a,b){var c=b||k;return function(b,d){var e=b[0],f=b[1];if(e)return b;switch(d.cmd){case"start":return g.doStart(d,a,c);case"insert":return g.doInsert(h.toArray(h.getOrElse(d.doc),[]),a,c);case"save":return g.doSave(h.toArray(d.doc),a,c);case"update":return g.doUpdate(d.query,h.getOrElse(d.update,{}),h.getOrElse(d.option,{}),a,c);case"remove":return g.doRemove(d.query,h.getOrElse(d.justOne,!1),a,c);case"find":return g.doFind(f,d.query);case"project":return g.doProject(f,h.getOrElse(d.projection,{}));case"limit":return g.doLimit(f,h.getOrElse(d.value,15));case"skip":return g.doSkip(f,h.getOrElse(d.value,0));case"count":return g.doCount(f);case"size":return g.doSize(f);case"toArray":return g.doToArray(f);case"max":return g.doMax(f,h.getOrElse(d.indexBounds,{}));case"min":return g.doMin(f,h.getOrElse(d.indexBounds,{}));case"forEach":return g.doForEach(f,h.getOrElse(d.func,null));case"map":return g.doMap(f,h.getOrElse(d.func,null));case"sort":return g.doSort(f,h.getOrElse(d.sorter,{_id:1}));default:return b}}},a.postMessage=a.webkitPostMessage||a.postMessage||function(){},g.send=function(b){b.seqs=self.seqs;var c=JSON.stringify(b),d=h.str2ab(c);a.postMessage(d,[d])},a.addEventListener=a.addEventListener||function(){},a.addEventListener("message",function(a){var b,d,e,f,j,l=[];if(b=h.tryParseJSON(h.ab2str(a.data)),b[0])return g.send({seq:-1,error:b[0],result:[]});d=b[1]||{},e=d.cmds,f=d.seq,k.isUpdatedBySeq[f]=!1,j=g.getExecuter(f,k);try{l=c.reduce(e,j,[null,g.getDataset()])}catch(m){return g.send({seq:f,error:m,result:[]})}l[0]===i&&(l[0]=null),g.send({seq:f,error:l[0],result:l[1],isUpdated:k.isUpdatedBySeq[f]})},!1),"undefined"!=typeof exports&&("undefined"!=typeof module&&module.exports&&(module.exports=g),exports.LongoWorker=g)}("undefined"!=typeof self?self:this,Longo,_);
//# sourceMappingURL=longoWorker.min.map