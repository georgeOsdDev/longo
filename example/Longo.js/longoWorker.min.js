/*
 * longo v-0.1.0
 * Source code can be found at https://github.com/georgeosddev/longo
 *
 * license   The MIT License (MIT)
 * copyright Copyright (c) 2014 Takeharu Oshida <georgeosddev@gmail.com>
 */

function applyOperator(a,b){"use strict";var c,d=_.identity(b),e=_.keys(a);return _.each(e,function(e){switch(c=a[e],e){case"$inc":_.each(_.keys(c),function(a){_.isNumber(b[a])&&_.isNumber(c[a])&&(d[a]=b[a]+c[a])});break;case"$mul":_.each(_.keys(c),function(a){_.isNumber(b[a])&&_.isNumber(c[a])&&(d[a]=b[a]*c[a])});break;case"$rename":_.each(_.keys(c),function(a){_.has(b,a)&&(d[c[a]]=b[a])});break;case"$set":_.each(_.keys(c),function(a){_.has(b,a)&&(d[a]=c[a])});break;case"$unset":_.each(_.keys(c),function(a){_.has(b,a)&&delete d[a]});break;case"$mod":_.each(_.keys(c),function(a){_.isNumber(b[a])&&_.isNumber(c[a])&&(d[a]=b[a]%c[a])})}}),d}function objectId(a){"use strict";return a||Date.now()+_.shuffle(CHARS).join("").substr(0,11)}function toQuery(a){"use strict";return Utils.checkOrElse(a,{},function(a){return _.isObject(a)&&!_.isArray(a)&&!_.isFunction(a)})}function toDocument(a){"use strict";if(_.isObject(a)&&!_.isArray(a))return a;var b=Utils.toArray(a),c=_.keys(b);return _.object(c,b)}function doStart(a,b){"use strict";return self.name=a.name,self.option=a.option,self.dataset=a.dataset,self.isUpdatedBySeq[b]=!0,self.logger("Longo Collection Worker Started","info"),[null,[]]}function doFind(a,b){"use strict";return[null,_.query(a,b)]}function doInsert(a,b){"use strict";if(Utils.isZero(_.size(a)))return[SKIP_REST,null];var c=_.omit(toDocument(_.first(a)),UPDATE_OPERATORS);if(c._id){if(_.where(self.dataset,{_id:c._id}).length>0)return[new Longo.Error(Longo.Error.DUPLICATE_KEY_ERROR,"_id: "+c._id),c]}else c._id=objectId();return self.dataset.push(c),self.isUpdatedBySeq[b]=!0,doInsert(_.rest(a),b)}function updateById(a,b,c){"use strict";if(b=toDocument(b),b._id)return[new Longo.Error(Longo.Error.MOD_ID_NOT_ALLOWED,"_id: "+b._id),null];var d=_.pick(b,UPDATE_OPERATORS),e=_.omit(b,UPDATE_OPERATORS);if(_.size(d)>0){if(_.size(e)>0)return[new Longo.Error(Longo.Error.INVALID_MODIFIER_SPECIFIED,e[0]),null];b=applyOperator(b,a)}return b._id=a._id,self.dataset=_.reject(self.dataset,function(b){return b._id===a._id}).concat([b]),self.isUpdatedBySeq[c]=!0,[null,null]}function doUpdate(a,b,c,d){"use strict";var e,f;if(e=doFind(self.dataset,a)[1],Utils.isZero(_.size(e)))return c.upsert?doInsert(Utils.toArray(b),d):[new Longo.Error(Longo.Error.DOCUMENT_NOT_FOUND,"query: "+JSON.stringify(a)),null];if(Utils.isOne(_.size(e)))return f=e[0],updateById(f,b,d);if(!c.multi)return updateById(f,b,d);if(b._id)return[new Longo.Error(Longo.Error.MOD_ID_NOT_ALLOWED,"_id: "+b._id),null];var g=[null,null];return _.every(e,function(a){return g=updateById(a,b,d),null===g[0]}),g}function doSave(a,b){"use strict";var c,d;if(Utils.isZero(_.size(a)))return[SKIP_REST,null];if(c=_.first(a),c._id){if(d=doUpdate({_id:c._id},c,{upsert:!0},b),d[0]&&d[0]!==SKIP_REST)return d}else d=doInsert(Utils.toArray(c),b);return doSave(_.rest(a),b)}function doRemove(a,b,c){"use strict";var d,e=doFind(self.dataset,a)[1];return Utils.isZero(_.size(e))?[new Longo.Error(Longo.Error.DOCUMENT_NOT_FOUND,"query: "+JSON.stringify(a)),null]:(b?self.dataset=_.reject(self.dataset,function(a){return a._id===e[0]._id}):(d=_.pluck(e,"_id"),self.dataset=_.reject(self.dataset,function(a){return _.contains(d,a._id)})),self.isUpdatedBySeq[c]=!0,[null,null])}function doProject(a,b){"use strict";var c,d=_.pairs(b),e=_.filter(d,function(a){return Utils.isOne(a[1])||Utils.isTrue(a[1])}),f=_.filter(d,function(a){return Utils.isZero(a[1])||Utils.isFalse(a[1])});return _.size(e)>0?(c=_.pluck(e,"0"),c=Utils.isZero(b._id)||Utils.isFalse(b._id)?_.without(c,"_id"):_.union(c,["_id"]),[null,_.map(a,function(a){return _.pick(a,c)})]):(c=_.pluck(f,"0"),[null,_.map(a,function(a){return _.omit(a,c)})])}function doLimit(a,b){"use strict";return[null,_.first(a,b)]}function doSkip(a,b){"use strict";return[null,_.rest(a,b)]}function doCount(a){"use strict";return[SKIP_REST,[_.size(a)]]}function doSize(a){"use strict";return[SKIP_REST,[Utils.str2ab(JSON.stringify(a)).bytesize]]}function doToArray(a){"use strict";return[null,a]}function doMax(a,b){"use strict";var c,d,e;return c=_.keys(b),d=_.values(b,function(a){return{$lte:a}}),e=_.object(c,d),doFind(a,e)}function doMin(a,b){"use strict";var c,d,e;return c=_.keys(b),d=_.values(b,function(a){return{$gte:a}}),e=_.object(c,d),doFind(a,e)}function doForEach(a,b){"use strict";if(!b)return[null,a];var c=new Function(b+"")();try{return[null,_.forEach(a,c)]}catch(d){return[new Longo.Error(Longo.Error.EVAL_ERROR,"function: "+b,d.stack),null]}}function doMap(a,b){"use strict";if(!b)return[null,a];var c=new Function(b+"")();try{return[null,_.map(a,c)]}catch(d){return[new Longo.Error(Longo.Error.EVAL_ERROR,"function: "+b,d.stack),null]}}function doSort(a,b){"use strict";if(!_.isString(b)){var c,d=_.keys(b)[0],e=b[d];return c=_.sortBy(a,d),Utils.isOne(e)?[null,c]:[null,c.reverse()]}var f=new Function(b+"")();try{return[null,_.sortBy(a,f)]}catch(g){return[new Longo.Error(Longo.Error.EVAL_ERROR,"sorter: "+b,g.stack),null]}}function getExecuter(a){"use strict";return function(b,c){var d=b[0],e=b[1];if(d)return b;switch(c.cmd){case"start":return doStart(c,a);case"find":return doFind(e,toQuery(c.criteria));case"insert":return doInsert(Utils.toArray(Utils.getOrElse(c.doc),[]),a);case"save":return doSave(Utils.toArray(c.doc),a);case"update":return doUpdate(toQuery(c.criteria),Utils.getOrElse(c.update,{}),Utils.getOrElse(c.option,{}),a);case"remove":return doRemove(toQuery(c.criteria),Utils.getOrElse(c.justOne,!1),a);case"project":return doProject(e,Utils.getOrElse(c.projection,{}));case"limit":return doLimit(e,Utils.getOrElse(c.value,15));case"skip":return doSkip(e,Utils.getOrElse(c.value,0));case"count":return doCount(e);case"size":return doSize(e);case"toArray":return doToArray(e);case"max":return doMax(e,Utils.getOrElse(c.indexBounds,{}));case"min":return doMin(e,Utils.getOrElse(c.indexBounds,{}));case"forEach":return doForEach(e,Utils.getOrElse(c.func,null));case"map":return doMap(e,Utils.getOrElse(c.func,null));case"sort":return doSort(e,Utils.getOrElse(c.sorter,{_id:1}));default:return b}}}self.logger=function(a,b){"use strict";var c={msg:a,workerName:self.name},d=b||"log",e=console||void 0;void 0!==typeof e&&e[d]&&e[d].call(e,JSON.stringify(c))},importScripts("./lib/underscore/underscore-min.js","./lib/underscore-query/lib/underscore-query.min.js","./longo.min.js");var Utils=Longo.Utils;self.dataset=[],self.option={capped:!1},self.isUpdatedBySeq={};var SKIP_REST="SKIP_REST",CHARS="abcdefghijklmnopqrstuvwxyz0123456789".split(""),UPDATE_OPERATORS=["$inc","$mul","$rename","$setOnInsert","$set","$unset","$min","$max","$currentDate","$invert"];self.send=function(a){"use strict";a.seqs=self.seqs;var b=JSON.stringify(a),c=Utils.str2ab(b);self.postMessage(c,[c.buffer])},self.addEventListener("message",function(a){"use strict";var b,c,d,e,f,g=[];return b=Utils.tryParseJSON(Utils.ab2str(a.data)),b[0]?self.send({seq:-1,error:b[0],result:[]}):(c=b[1]||{},d=c.cmds,e=c.seq,self.isUpdatedBySeq[e]=!1,f=getExecuter(e),g=_.reduce(d,f,[null,self.dataset]),g[0]===SKIP_REST&&(g[0]=null),void self.send({seq:e,error:g[0],result:g[1],isUpdated:self.isUpdatedBySeq[e]}))},!1);
//# sourceMappingURL=longoWorker.min.map