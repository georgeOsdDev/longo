define(function(){var e,t,r,n,s,i,u,a,c,o,l,h,f,d,y,p,$,g,x,m,v,k,b,w=[].indexOf||function(e){for(var t=0,r=this.length;r>t;t++)if(t in this&&this[t]===e)return t;return-1},Q={}.hasOwnProperty;y=this,m={},n=function(e){var t,r,n,s;for(s=["every","some","filter","detect","reject","reduce","intersection","isEqual","keys","isArray","result","groupBy","map","each"],r=0,n=s.length;n>r;r++)if(t=s[r],m[t]=e[t],!m[t])throw new Error("Please ensure that you first initialize      underscore-query with either lodash or underscore")},m.getType=function(e){var t;return t=Object.prototype.toString.call(e).substr(8),t.substr(0,t.length-1)},m.makeObj=function(e,t){var r;return(r={})[e]=t,r},m.reverseString=function(e){return e.toLowerCase().split("").reverse().join("")},m.compoundKeys=["$and","$not","$or","$nor"],m.makeGetter=function(e){return e=e.split("."),function(t){var r,n,s,i;for(n=t,s=0,i=e.length;i>s;s++)r=e[s],n&&(n=m.result(n,r));return n}},o=function(e){var t,r,n,s,i,u;switch(t=m.keys(e)[0],s=e[t],r={key:t},-1!==t.indexOf(".")&&(r.getter=m.makeGetter(t)),n=m.getType(s)){case"RegExp":case"Date":r.type="$"+n.toLowerCase(),r.value=s;break;case"Object":if(w.call(m.compoundKeys,t)>=0)r.type=t,r.value=h(s),r.key=null;else for(i in s)if(Q.call(s,i)){if(u=s[i],!x(i,u))throw new Error("Query value ("+u+") doesn't match query type: ("+i+")");switch(r.type=i,i){case"$elemMatch":r.value=$(l(u));break;case"$endsWith":r.value=m.reverseString(u);break;case"$likeI":case"$startsWith":r.value=u.toLowerCase();break;case"$computed":r=o(m.makeObj(t,u)),r.getter=m.makeGetter(t);break;default:r.value=u}}break;default:r.type="$equal",r.value=s}return"$equal"!==r.type||"Object"!==n&&"Array"!==n||(r.type="$deepEqual"),r},h=function(e){var t,r,n,s,i,u,a;for(n=m.isArray(e)?e:function(){var r;r=[];for(t in e)Q.call(e,t)&&(s=e[t],r.push(m.makeObj(t,s)));return r}(),a=[],i=0,u=n.length;u>i;i++)r=n[i],a.push(o(r));return a},x=function(e,t){var r;switch(r=m.getType(t),e){case"$in":case"$nin":case"$all":case"$any":return"Array"===r;case"$size":return"Number"===r;case"$regex":case"$regexp":return"RegExp"===r;case"$like":case"$likeI":return"String"===r;case"$between":case"$mod":return"Array"===r&&2===t.length;case"$cb":return"Function"===r;default:return!0}},g=function(e,t){var r;switch(r=m.getType(t),e){case"$like":case"$likeI":case"$regex":case"$startsWith":case"$endsWith":return"String"===r;case"$contains":case"$all":case"$any":case"$elemMatch":return"Array"===r;case"$size":return"String"===r||"Array"===r;case"$in":case"$nin":return null!=t;default:return!0}},f=function(e,t,r,n,s){switch(e){case"$equal":return m.isArray(r)?w.call(r,t)>=0:r===t;case"$deepEqual":return m.isEqual(r,t);case"$contains":return w.call(r,t)>=0;case"$ne":return r!==t;case"$lt":return t>r;case"$gt":return r>t;case"$lte":return t>=r;case"$gte":return r>=t;case"$between":return t[0]<r&&r<t[1];case"$betweene":return t[0]<=r&&r<=t[1];case"$in":return w.call(t,r)>=0;case"$nin":return w.call(t,r)<0;case"$all":return m.every(t,function(e){return w.call(r,e)>=0});case"$any":return m.some(r,function(e){return w.call(t,e)>=0});case"$size":return r.length===t;case"$exists":case"$has":return null!=r===t;case"$like":return-1!==r.indexOf(t);case"$likeI":return-1!==r.toLowerCase().indexOf(t);case"$startsWith":return 0===r.toLowerCase().indexOf(t);case"$endsWith":return 0===m.reverseString(r).indexOf(t);case"$type":return typeof r===t;case"$regex":case"$regexp":return t.test(r);case"$cb":return t.call(n,r);case"$mod":return r%t[0]===t[1];case"$elemMatch":return p(r,t,null,!0);case"$and":case"$or":case"$nor":case"$not":return d(e,t,s,n);default:return!1}},$=function(e,t){var r;return"String"===m.getType(t)&&(r=t,t=function(e,t){return e[r](t)}),function(r){var n,s,i;for(s=0,i=e.length;i>s;s++)if(n=e[s],!d(n.type,n.parsedQuery,t,r))return!1;return!0}},d=function(e,t,r,n){var s,i,u,a,c,o;for(i=0,c=0,o=t.length;o>c;c++)switch(u=t[c],s=u.getter?u.getter(n,u.key):r?r(n,u.key):n[u.key],a=g(u.type,s),a&&(a=f(u.type,u.value,s,n,r)),a&&i++,e){case"$and":if(!a)return!1;break;case"$not":if(a)return!1;break;case"$or":if(a)return!0;break;case"$nor":if(a)return!1;break;default:throw new Error("Invalid compound method")}return"$not"===e?0===i:"$or"!==e},l=function(e){var t,r,n,s,i;if(n=m.keys(e),!n.length)return[];if(t=m.intersection(m.compoundKeys,n),0===t.length)return[{type:"$and",parsedQuery:h(e)}];if(t.length!==n.length){w.call(t,"$and")<0&&(e.$and={},t.unshift("$and"));for(r in e)Q.call(e,r)&&(i=e[r],w.call(m.compoundKeys,r)<0&&(e.$and[r]=i,delete e[r]))}return function(){var r,n,i;for(i=[],r=0,n=t.length;n>r;r++)s=t[r],i.push({type:s,parsedQuery:h(e[s])});return i}()},c=function(e){var t;return"String"===m.getType(e)&&(t=e,e=function(e,r){return e[t](r)}),e},e=function(){function e(e,t){this.items=e,this._getter=t,this.theQuery={}}return e.prototype.indexQueries=function(){var e,t,r,n,s,i;i=this.theQuery;for(s in i)if(Q.call(i,s)){for(r=i[s],e=0;e<r.length;)n=r[e],t=m.keys(n)[0],t in this.indexes&&"$and"===s&&"String"===m.getType(n[t])?(this._indexQueries[t]=n[t],r.splice(e,1)):e++;r.length||delete this.theQuery[s]}return this._indexQueries},e.prototype.getIndexedItems=function(e){var t,r,n,s,i;t=this.indexQueries();for(r in t)Q.call(t,r)&&(n=t[r],e=this.indexKeys.length>1?m.intersection(e,null!=(s=this.indexes[r][n])?s:[]):null!=(i=this.indexes[r][n])?i:[]);return e},e.prototype.all=function(e,t){return e&&(this.items=e),e=this.indexes?this.getIndexedItems(this.items):this.items,p(e,this.theQuery,this._getter,t)},e.prototype.chain=function(){return _.chain(this.all.apply(this,arguments))},e.prototype.clone=function(){var t;return t=new e(this.items,this._getter),this.indexes&&(t._indexQueries={},t.indexes=this.indexes,t.indexKeys=this.indexKeys),t},e.prototype.tester=function(){return a(this.theQuery,this._getter)},e.prototype.first=function(e){return this.all(e,!0)},e.prototype.getter=function(e){return this._getter=e,this},e.prototype.index=function(e,t){if(!this.items)throw new Error("Index should only be called after items have been added.");return null==t&&(t=e),null==this.indexes&&(this.indexes={}),null==this.indexKeys&&(this.indexKeys=[]),null==this._indexQueries&&(this._indexQueries={}),w.call(this.indexKeys,e)<0&&this.indexKeys.push(e),this.indexes[e]=m.groupBy(this.items,t),this},e}(),t=function(e){return function(t,r){var n;return r&&(t=m.makeObj(t,r)),null==(n=this.theQuery)[e]&&(n[e]=[]),this.theQuery[e].push(t),this}},b=m.compoundKeys;for(v=0,k=b.length;k>v;v++)u=b[v],e.prototype[u.substr(1)]=t(u);return e.prototype.find=e.prototype.query=e.prototype.run=e.prototype.all,r=function(t,r){return new e(t,r)},a=function(e,t){return $(l(e),c(t))},i=function(e,t,r){return p(e,t,r,!0)},p=function(e,t,n,s){var i;return arguments.length<2?r.apply(this,arguments):(n&&(n=c(n)),"Function"!==m.getType(t)&&(t=$(l(t),n)),i=s?m.detect:m.filter,i(e,t))},p.build=r,p.parse=l,p.findOne=p.first=i,p.tester=p.testWith=a,p.getter=p.pluckWith=m.makeGetter,s=function(e,t){return null==t&&(t=!0),n(e),t&&e.mixin({query:p,q:p}),p},y._?s(y._):exports&&("undefined"!=typeof module&&null!==module?module.exports:void 0)?module.exports=s:s});