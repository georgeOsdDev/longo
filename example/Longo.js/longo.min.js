/*
 * longo v-0.2.0
 * Source code can be found at https://github.com/georgeosddev/longo
 *
 * The MIT License (MIT)
 * Copyright (c) 2014 Takeharu Oshida <georgeosddev@gmail.com>
 */

if("undefined"!=typeof module&&module.exports)var _=require("underscore"),Promise=require("promise"),EventEmitter=require("events").EventEmitter;!function(a,b,c,d){"use strict";function e(a){return new g.Error(a.code,a.message,a.stack)}var f=a,g=a.Longo={};g.VERSION="0.1.0",g.LONGOROOT="/Longo.js",g.WORKERJS="longoWorker.js",g.LOGLEVEL="warn";var h=g.Status={CREATED:0,STARTED:1,STOPPED:2,DELETED:3};g.Error=function(a,b,c){this.code=a,this.message=b,this.stack=c||(new Error).stack},g.Error.UNEXPECTED_ERROR=1,g.Error.EXECUTION_ERROR=2,g.Error.WEBWORKER_ERROR=3,g.Error.INVALID_QUERY=4,g.Error.COLLECTION_NOT_FOUND=5,g.Error.COLLECTION_ALREADY_EXISTS=6,g.Error.COLLECTION_NOT_STARTED=7,g.Error.DUPLICATE_KEY_ERROR=8,g.Error.DOCUMENT_NOT_FOUND=9,g.Error.MOD_ID_NOT_ALLOWED=10,g.Error.NOT_SUPPOETRD=11,g.Error.EVAL_ERROR=12,g.Error.INVALID_MODIFIER_SPECIFIED=13,g.Error.PARSE_ERROR=14,g.ErrorCds=b.invert(g.Error);var i=g.Utils={ab2str:function(a){return String.fromCharCode.apply(null,new Uint16Array(a))},str2ab:function(a){for(var b=new ArrayBuffer(2*a.length),c=new Uint16Array(b),d=0,e=a.length;e>d;d++)c[d]=a.charCodeAt(d);return c.buffer},inherits:function(a,b){a._super=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})},createLogger:function(b,c){var d={log:4,debug:3,info:2,warn:1,error:0},e={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){}},f=d[c+"".toLowerCase()]||5;return a.console?(f>3&&a.console.log&&a.console.log.bind&&(e.log=function(){return a.console.log.bind(a.console,b)}()),f>2&&a.console.debug&&a.console.debug.bind&&(e.debug=function(){return a.console.debug.bind(a.console,b)}()),f>1&&a.console.info&&a.console.info.bind&&(e.info=function(){return a.console.info.bind(a.console,b)}()),f>0&&a.console.warn&&a.console.warn.bind&&(e.warn=function(){return a.console.warn.bind(a.console,b)}()),a.console.error&&a.console.error.bind&&(e.error=function(){return a.console.error.bind(a.console,b)}()),e):e},noop:function(){return void 0},asNoop:function(){return i.noop},aSlice:function(a){return Array.prototype.slice.apply(a)},toArray:function(a){return b.isArray(a)?a:[a]},existy:function(a){return null!==a&&a!==d},truthy:function(a){return a!==!1&&i.existy(a)},isTrue:function(a){return a===!0},isFalse:function(a){return a===!1},isNegativeNum:function(a){return b.isNumber(a)&&0>a},isZero:function(a){return 0===a},isOne:function(a){return 1===a},isPositiveNum:function(a){return b.isNumber(a)&&a>0},doWhen:function(a,b,c,d){var e=i.toArray(c);return i.truthy(a)?b.apply(d,e):i.noop()},doWhenOrElse:function(a,b,c,d,e){var f=i.toArray(d);return i.truthy(a)?b.apply(e,f):c.apply(e,f)},getOrElse:function(a,b){return i.existy(a)?a:b},checkOrElse:function(a,b,c){return i.truthy(c(a))?a:b},tryParseJSON:function(a){var b=[null,null];try{b[1]=JSON.parse(a)}catch(c){b[0]=new g.Error(g.Error.PARSE_ERROR,"Failed to parse: "+a,c.stack)}return b},objectId:function(){var a=Date.now(),c=0,d="abcdefghijklmnopqrstuvwxyz0123456789".split("");return function(e){if(e)return e;var f=Date.now();return f===a?(c++,f=f+""+Number(c+"",16)):(a=f,c=0,f=f+""+c),(f+b.shuffle(d).join("")).substr(0,24)}}(),dataFromId:function(a){return new Date(Number(a.substr(0,13)))},uuid:function(){var a=function(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)};return function(){return a()+a()+a()+a()}}(),defer:function(a){return new Promise(function(b,c){return a(b,c)})},clone:function(a){if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},deepClone:function(a){if(null===a||"object"!=typeof a)return a;var b=a.constructor();for(var c in a)a.hasOwnProperty(c)&&(b[c]="object"==typeof a[c]?i.deepClone(a[c]):a[c]);return b},nextTick:function(a){setTimeout(a,0)}};i.inherits(g.Error,Error),c||(c=function(){this.dom=f.document.createDocumentFragment(),this.listners={}},c.prototype.addEventListener=function(){this.dom.addEventListener.apply(this.dom,g.Utils.aSlice(arguments))},c.prototype.removeEventListener=function(){this.dom.removeEventListener.apply(this.dom,g.Utils.aSlice(arguments))},c.prototype.dispatchEvent=function(){var a=g.Utils.aSlice(arguments);if(a[0]){if("Event"!==a[0].constructor.name||"CustomEvent"!==a[0].constructor.name){var b=a[1]&&a[1].detail?a[1].detail:a[1],c=new CustomEvent(a[0].toString(),{detail:b});a[0]=c}this.dom.dispatchEvent.apply(this.dom,a)}},c.prototype.on=c.prototype.addEventListener,c.prototype.bind=c.prototype.addEventListener,c.prototype.off=c.prototype.removeEventListener,c.prototype.unbind=c.prototype.removeEventListener,c.prototype.emit=c.prototype.dispatchEvent,c.prototype.trigger=c.prototype.dispatchEvent,a.console&&a.console.warn&&a.console.warn(["[WARN]:EventEmitter is not imported.","Longo use dom based EventEmitter by default.","For better performance, please use Wolfy87's EventEmitter implementation.","https://github.com/Wolfy87/EventEmitter"].join(" "))),g.EventEmitter=c;var j=g.DB=function(a){c.call(this),this.name=a,this.lastError=null,this.currentOpId=null,this.collections={},this.logger=g.Utils.createLogger("Longo."+a,g.LOGLEVEL)};g.Utils.inherits(j,c),g.DB.prototype.getCollectionNames=function(){return b.keys(this.collections)},g.DB.prototype.getCollection=function(a){return this.collections[a]||this.collection(a)},g.DB.prototype.createCollection=function(a,b){return this._createCollectionWithData(a,b)},g.DB.prototype._createCollectionWithData=function(a,b,c){var d=i.getOrElse(a,"temp")+"",e=i.getOrElse(b,{}),f=new k(d,e,this);return f._initialize(c),this.collections[d]=f,f},g.DB.prototype.collection=function(a){var b,c,d;return b=i.getOrElse(a,"temp")+"",this.collections[b]?this.collections[b]:(c=i.tryParseJSON(localStorage.getItem("Longo:"+this.name+":"+b)),d=i.toArray(i.getOrElse(c[1],[])),this._createCollectionWithData(a,{},d))},g.DB.prototype.dropDatabase=function(){b.each(b.values(this.collections),function(a){a.drop()}),g._dropDB(this.name)},g.DB.prototype.cloneCollection=function(a,c,d,e){var f=this,h=i.getOrElse(c,"temp")+"";if(b.isFunction(e)||(e=i.noop),this.collections[h]){var j=new g.Error(g.Error.COLLECTION_ALREADY_EXISTS,"Collection is already exists! name: "+h,null);return f.lastError=j,e(j,null)}if(!this.collections[a])return e(null,this.createCollection(h));var k=function(b,c){return i.existy(b)?e(b,null):e(null,f._createCollectionWithData(h,f.collections[a].option,c))};this.collection(a).find(d,{}).done(k)},g.DB.prototype.currentOp=function(){return this.currentOpId},g.DB.prototype.getLastError=function(){return this.lastError?this.lastError.message:null},g.DB.prototype.getLastErrorObj=function(){return this.lastError},g.DB.prototype.killOp=function(a){var b=a.split[":"];this.collections[b[0]]&&(delete this.collections[b[0]].cbs[b[1]],delete this.collections[b[0]].observers[b[1]])},g.DB.prototype.getName=function(){return this.name};var k=g.Collection=function(a,b,d){c.call(this);var e=this;this.name=a,this.option={capped:b.capped||!1,size:b.size||1048576,max:b.max||1e3,storeFunction:!1},this.db=d,this.logger=i.createLogger("Longo."+this.db.name+"."+this.name,g.LOGLEVEL),this.cbs={"-1":function(a){e.logger.error(["Error:Failed to detect specified callback.","If you want to handle this error with your own listener,","Use `db.collection('name').setDefaultErrorHandler(listner);`"].join(""),a)}},this.observers={};var f=this.worker=new Worker(g.getRoot()+"/"+g.WORKERJS);this.worker.postMessage=f.webkitPostMessage||f.postMessage,f.addEventListener("message",this._onMessage(),!1),f.addEventListener("error",this._onError(),!1),this.status=h.STARTED};i.inherits(k,c),g.Collection.prototype.isCapped=function(){return this.option.capped},g.Collection.prototype.setDefaultErrorHandler=function(a){this.cbs[-1]=a},g.Collection.prototype.parsist=function(){var a=this;this.find({}).onValue(function(b,c){localStorage.setItem("Longo:"+a.db.name+":"+a.name,JSON.stringify(c))})},g.Collection.prototype.parsistOnce=function(){var a=this;this.find({}).done(function(b,c){localStorage.setItem("Longo:"+a.db.name+":"+a.name,JSON.stringify(c))})},g.Collection.prototype._onMessage=function(){var a=this;return function(c){var d,f,h,j,k;return d=i.tryParseJSON(i.ab2str(c.data)),a.logger.info("Response Received",d),i.existy(d[0])?(j=e(d[0]),a.db.lastError=j,a.db.emit("error",j),a.emit("error",j),i.nextTick(function(){a.logger.error("ERROR:Failed to parse WebWorker message",g.ErrorCds[j.code])})):(f=d[1]||{},h=f.seq||"-1",k=f.result,i.existy(f.error)?(j=e(f.error),a.db.lastError=j,a.db.emit("error",j),a.emit("error",j),a.logger.error("ERROR:Failed at worker",j),i.nextTick(function(){i.doWhen(b.isFunction(a.cbs[h]),a.cbs[h],[j,null])})):(f.isUpdated&&(b.each(b.values(a.observers),function(c){b.isFunction(c.func)&&a._send(c.message,c.func,!1)}),a.emit("updated")),a.logger.info("Trigger callback: ",a.name+":"+h),void i.nextTick(function(){i.doWhen(b.isFunction(a.cbs[h]),a.cbs[h],[null,k])})))}},g.Collection.prototype._onError=function(){var a=this;return function(b){return i.existy(b.code)||(b.code=g.Error.WEBWORKER_ERROR),a.db.lastError=b,a.db.emit("error",b),a.emit("error",b),a.logger.error(["Error:WebWorker Error!  Line ",b.lineno," in ",b.filename,": ",b.message].join("")),b.preventDefault(),a.cbs[-1](b)}},g.Collection.prototype._initialize=function(a){var c=i.checkOrElse(a,[],b.isArray),d={cmds:[{cmd:"start",name:this.name,option:this.option,dataset:c}]};this._send(d)},g.Collection.prototype._getNextSeq=function(){var a=0,b=function(){return a++,a+""};return this._getNextSeq=b,a+""},g.Collection.prototype._send=function(a,c,d){var e,f,j,k,l;return f=i.checkOrElse(c,i.noop,b.isFunction),this.status!==h.STARTED?f(g.Error.COLLECTION_NOT_STARTED,null):(e=this._getNextSeq(),this.cbs[e]=f,a.seq=e,this.option.storeFunction,j=JSON.stringify(a),k=i.str2ab(j),this.worker.postMessage(k,[k]),this.logger.info("New operation called: "+this.name+":"+e),d&&(this.observers[e]={message:a,func:f},this.logger.info("New observer registerd: "+this.name+":"+e)),l=this.name+":"+e,this.db.currentOpId=l,l)},g.Collection.prototype.find=function(a,b){var c=[{cmd:"find",query:a},{cmd:"project",projection:b}];return new l(this,c)},g.Collection.prototype.findOne=function(a,b){var c=[{cmd:"find",query:a},{cmd:"project",projection:b},{cmd:"limit",value:1}];return new l(this,c)},g.Collection.prototype.aggregate=function(a){var c,d=new l(this,[]);return b.each(a,function(a){switch(c=b.keys(a)[0]){case"$project":d=d.project(a[c]);break;case"$match":d=d.match(a[c]);break;case"$skip":d=d.skip(a[c]);break;case"$unwind":d=d.unwind(a[c]);break;case"$group":d=d.group(a[c]);break;case"$sort":d=d.sort(a[c])}}),d},g.Collection.prototype.save=function(a){var b={cmd:"save",doc:a};return new l(this,b)},g.Collection.prototype.insert=function(a){var b={cmd:"insert",doc:i.toArray(a)};return new l(this,b)},g.Collection.prototype.remove=function(a,b){var c={cmd:"remove",query:a,justOne:b};return new l(this,c)},g.Collection.prototype.update=function(a,b,c){var d={cmd:"update",query:a,update:b,option:c};return new l(this,d)},g.Collection.prototype.drop=function(a){return this.emit("drop"),this.worker.terminate(),this.cbs={},this.observers={},delete this.db.collections[this.name],localStorage.setItem("Longo:"+this.db.name+":"+this.name,[]),b.isFunction(a)?a():i.defer(function(a){a()})},g.Collection.prototype.count=function(a){var b=[{cmd:"find",query:a},{cmd:"count"}];return new l(this,b)},g.Collection.prototype.dataSize=function(){var a=[{cmd:"size"}];return new l(this,a)},g.Collection.prototype.totalSize=g.Collection.prototype.dataSize,g.Collection.prototype.copyTo=function(a,b){var c=this;return this.db.cloneCollection(c.name,a+"",{},function(d,e){return d?c.find({}).done(function(d){return d?b(d):c.db.collection(a+"").count().dene(b)}):e.count().done(b)})},g.Collection.prototype.renameCollection=function(a){this.db.collections[a]=this,delete this.db.collections[this.name],this.name=a,this.logger=i.createLogger("Longo."+this.db.name+"."+this.name,g.LOGLEVEL)},g.Collection.prototype.distinct=function(){},g.Collection.prototype.findAndModify=function(){},g.Collection.prototype.group=function(){},g.Collection.prototype.mapReduce=function(){};var l=g.Cursor=function(){var a=i.aSlice(arguments);a[0]instanceof l?(this.collection=a[0].collection,this.cmds=a[0].cmds,this.wrapCb=a[0].wrapCb,this.cmds.push(i.getOrElse(a[1],{})),b.isFunction(a[2])&&this.wrapCb.push(a[2])):(this.collection=a[0],this.cmds=i.toArray(a[1]),this.wrapCb=i.toArray(i.getOrElse(a[2],i.noop)))};g.Cursor.prototype.done=function(a){var c,d,e,f=i.checkOrElse(a,i.noop,b.isFunction);return c=this,d={cmds:this.cmds},e=function(){var a=i.aSlice(arguments);b.invoke(c.wrapCb,"call"),f.apply(null,a)},this.collection._send(d,e)},g.Cursor.prototype.onValue=function(a,c){if(b.some([b.contains(b.keys(this.cmds),"save"),b.contains(b.keys(this.cmds),"insert"),b.contains(b.keys(this.cmds),"remove"),b.contains(b.keys(this.cmds),"update"),b.contains(b.keys(this.cmds),"drop")]))return this.collection.logger.warn("WARN:`onValue` is not supported for 'save','insert','remove','update','drop'. call `done` instead."),this.done(a);var d,e,f,g=i.checkOrElse(a,i.noop,b.isFunction);return d=this,e={cmds:this.cmds},f=function(){var a=null;return function(){var e=i.aSlice(arguments);b.invoke(d.wrapCb,"call");var f=JSON.stringify(e[1]);c&&b.isEqual(a,f)||(a=f,g.apply(null,e))}}(),this.collection._send(e,f,!0)},g.Cursor.prototype.assign=function(a,c){var d,e;return i.existy(a)&&i.existy(c)?(b.isFunction(a.html)?e=function(b,d){return b?this.collection.logger.error("Error:Assign Result Error",b):void a.html(c({result:d}))}:(d=document.querySelector(a),e=function(a,b){return a?this.collection.logger.error("Error:Assign Result Error",a):void(d.innerHTML=c({result:b}))}),this.onValue(e,!0)):this.collection.logger.error("Error:Assign Result Error",new g.Error(g.Error.EXECUTION_ERROR,"invalid parameter"))},g.Cursor.prototype.promise=function(){var a=this;return new Promise(function(c,d){var e=function(){var e=i.aSlice(arguments);b.invoke(a.wrapCb,"call"),e[0]?d(e[0]):c(e[1])};a.collection._send({cmds:a.cmds},e)})},g.Cursor.prototype.count=function(){var a={cmd:"count"};return new l(this,a)},g.Cursor.prototype.forEach=function(a){var b={cmd:"forEach",func:"return "+a.toString()+";"};return new l(this,b)},g.Cursor.prototype.limit=function(a){var b={cmd:"limit",value:a};return new l(this,b)},g.Cursor.prototype.map=function(a){var b={cmd:"map",func:"return "+a.toString()+";"};return new l(this,b)},g.Cursor.prototype.max=function(a){var b={cmd:"max",indexBounds:a||{}};return new l(this,b).limit(1)},g.Cursor.prototype.min=function(a){var b={cmd:"min",indexBounds:a||{}};return new l(this,b).limit(1)},g.Cursor.prototype.size=function(){var a={cmd:"count"};return new l(this,a)},g.Cursor.prototype.skip=function(a){var b={cmd:"skip",value:a};return new l(this,b)},g.Cursor.prototype.sort=function(a){var c={cmd:"sort",sorter:a};return b.isFunction(a)&&(c.sorter="return "+a.toString()+";"),new l(this,c)},g.Cursor.prototype.match=function(a){var b={cmd:"find",query:a};return new l(this,b)},g.Cursor.prototype.project=function(a){var b={cmd:"project",projection:a};return new l(this,b)},g.Cursor.prototype.unwind=function(a){var b={cmd:"unwind",projection:a};return new l(this,b)},g.Cursor.prototype.group=function(a){var b={cmd:"group",grouping:a};return new l(this,b)},g.getVersion=function(){return g.VERSION},g.setRoot=function(a){if("string"!=typeof a){a="/Longo.js";for(var b=f.document.getElementsByTagName("script"),c=b.length;c--;){var d=b[c].src.match(/(^|.*)\/longo(\.min){0,}\.js(\?.*)?$/);if(d){a=d[1],d[2]&&(g.WORKERJS="longoWorker.min.js"),d[3]&&(g.WORKERJS=g.WORKERJS+d[3]);break}}}g.LONGOROOT!==a&&console.info("Set LONGOROOT :"+a),g.LONGOROOT=a},f.addEventListener&&f.addEventListener("load",g.setRoot,!1),g.getRoot=function(){return g.LONGOROOT},g.useMinified=function(){g.WORKERJS="longoWorker.min.js"},g.setLogLevel=function(a){g.LOGLEVEL=a},function(){var a={};g.createDB=function(c){var d,e=i.getOrElse(c,"temp")+"";return b.has(a,e)?a[e]:(d=new j(e),a[e]=d,d)},g._dropDB=function(b){a[b]&&delete a[b]}}(),g.use=g.createDB,"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(module.exports=g),exports.Longo=g):a.Longo=g}(this,_,void 0!==typeof EventEmitter?EventEmitter:void 0);
//# sourceMappingURL=longo.min.map