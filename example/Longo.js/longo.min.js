/*
 * longo v-0.1.0
 * Source code can be found at https://github.com/georgeosddev/longo
 *
 * The MIT License (MIT)
 * Copyright (c) 2014 Takeharu Oshida <georgeosddev@gmail.com>
 */

!function(a,b){"use strict";function c(a){return new e.Error(a.code,a.message,a.stack)}var d=a,e=a.Longo={};e.VERSION="0.1.0",e.LONGOROOT="/Longo.js",e.WORKERJS="longoWorker.js",e.LOGLEVEL="warn";var f=e.Status={CREATED:0,STARTED:1,STOPPED:2,DELETED:3};e.Error=function(a,b,c){this.code=a,this.message=b,this.stack=c||(new Error).stack},e.Error.UNEXPECTED_ERROR=1,e.Error.EXECUTION_ERROR=2,e.Error.WEBWORKER_ERROR=3,e.Error.INVALID_QUERY=4,e.Error.COLLECTION_NOT_FOUND=5,e.Error.COLLECTION_ALREADY_EXISTS=6,e.Error.COLLECTION_NOT_STARTED=7,e.Error.DUPLICATE_KEY_ERROR=8,e.Error.DOCUMENT_NOT_FOUND=9,e.Error.MOD_ID_NOT_ALLOWED=10,e.Error.NOT_SUPPOETRD=11,e.Error.EVAL_ERROR=12,e.Error.INVALID_MODIFIER_SPECIFIED=13,e.ErrorCds=_.invert(e.Error);var g=e.Utils={ab2str:function(b){return String.fromCharCode.apply(null,new a.Uint16Array(b))},str2ab:function(b){for(var c=new a.ArrayBuffer(2*b.length),d=new a.Uint16Array(c),e=0,f=b.length;f>e;e++)d[e]=b.charCodeAt(e);return d},inherits:function(a,b){a._super=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})},createLogger:function(a,b){var c={log:4,debug:3,info:2,warn:1,error:0},e={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){}},f=c[b+"".toLowerCase()]||5;return d.console?(f>3&&(e.log=function(){return d.console.log.bind(d.console,a)}()),f>2&&(e.debug=function(){return d.console.debug.bind(d.console,a)}()),f>1&&(e.info=function(){return d.console.info.bind(d.console,a)}()),f>0&&(e.warn=function(){return d.console.warn.bind(d.console,a)}()),e.error=function(){return d.console.error.bind(d.console,a)}(),e):e},noop:function(){return void 0},asNoop:function(){return g.noop},aSlice:function(a){return Array.prototype.slice.apply(a)},toArray:function(a){return _.isArray(a)?a:[a]},existy:function(a){return null!==a&&a!==b},truthy:function(a){return a!==!1&&g.existy(a)},isTrue:function(a){return a===!0},isFalse:function(a){return a===!1},isNegativeNum:function(a){return _.isNumber(a)&&0>a},isZero:function(a){return 0===a},isOne:function(a){return 1===a},isPositiveNum:function(a){return _.isNumber(a)&&a>0},doWhen:function(a,b,c,d){var e=g.toArray(c);return g.truthy(a)?b.apply(d,e):g.noop()},doWhenOrElse:function(a,b,c,d,e){var f=g.toArray(d);return g.truthy(a)?b.apply(e,f):c.apply(e,f)},getOrElse:function(a,b){return g.existy(a)?a:b},checkOrElse:function(a,b,c){return g.truthy(c(a))?a:b},tryParseJSON:function(a){var b=[null,null];try{b[1]=JSON.parse(a)}catch(c){b[0]=new e.Error(Error.PARSE_ERROR,"Failed to parse: "+a,c.stack)}return b},dataFromId:function(a){return new Date(Number(a.substr(0,13)))}};g.inherits(e.Error,Error);var h=e.EventEmitter;d.EventEmitter?h=d.EventEmitter:(h=function(){this.dom=d.document.createDocumentFragment()},h.prototype.addEventListener=function(){this.dom.addEventListener.apply(this.dom,e.Utils.aSlice(arguments))},h.prototype.removeEventListener=function(){this.dom.removeEventListener.apply(this.dom,e.Utils.aSlice(arguments))},h.prototype.dispatchEvent=function(){var b=e.Utils.aSlice(arguments),c=b[0];if(c){if("Event"!==c.constructor.name){var d=new a.CustomEvent(b[0].toString(),b[1]);d.data=b.slice(1),b[0]=d}this.dom.dispatchEvent.apply(this.dom,b)}},h.prototype.on=h.prototype.addEventListener,h.prototype.bind=h.prototype.addEventListener,h.prototype.off=h.prototype.removeEventListener,h.prototype.unbind=h.prototype.removeEventListener,h.prototype.emit=h.prototype.dispatchEvent,h.prototype.trigger=h.prototype.dispatchEvent,d.console&&d.console.warn&&d.console.warn(["[WARN]:EventEmitter is not imported.","Longo use dom based EventEmitter by default.","For better performance, please use Wolfy87's EventEmitter implementation.","https://github.com/Wolfy87/EventEmitter"].join(" ")));var i=e.DB=function(a){h.call(this),this.name=a,this.lastError=null,this.currentOpId=null,this.collections={},this.logger=e.Utils.createLogger("Longo."+a,e.LOGLEVEL)};e.Utils.inherits(i,h),e.DB.prototype.getCollectionNames=function(){return _.keys(this.collections)},e.DB.prototype.getCollection=function(a){return this.collections[a]||this.collection(a)},e.DB.prototype.createCollection=function(a,b){return this._createCollectionWithData(a,b)},e.DB.prototype._createCollectionWithData=function(a,b,c){var d=g.getOrElse(a,"temp")+"",e=new j(d,b,this);return e.initialize(c),this.collections[d]=e,e},e.DB.prototype.collection=function(a){var b,c,d;return b=g.getOrElse(a,"temp")+"",this.collections[b]?this.collections[b]:(c=JSON.parse(localStorage.getItem("Longo:"+this.name+":"+b)),d=g.toArray(g.getOrElse(c,[])),this._createCollectionWithData(a,{},d))},e.DB.prototype.dropDatabase=function(){_.each(_.values(this.collections),function(a){a.drop().done()})},e.DB.prototype.cloneCollection=function(a,b,c,d){var f=g.getOrElse(b,"temp")+"";if(_.isFunction(d)||(d=g.noop),!this.collections[f])return d(new e.Error(e.Error.COLLECTION_ALREADY_EXISTS,"Collection is already exists! name: "+f,null),null);if(!this.collections[a])return d(null,this.createCollection(f));var h=function(a,c){return g.existy(a)?d(a,null):d(null,this._createCollectionWithData(b,{},c))};this.collection(a).find(c,{}).done(h)},e.DB.prototype.currentOp=function(){return this.currentOpId},e.DB.prototype.getLastError=function(){return this.lastError.message},e.DB.prototype.getLastErrorObj=function(){return this.lastError},e.DB.prototype.killOp=function(a){var b=a.split[":"];this.collections[b[0]]&&(delete this.collections[b[0]].cbs[[1]],delete this.collections[b[0]].observers[[1]])},e.DB.prototype.getName=function(){return this.name};var j=e.Collection=function(a,b,c){h.call(this);var d=this;this.name=a,this.option={capped:b.capped||!1,size:b.size||1048576,max:b.max||1e3,storeFunction:!1},this.db=c,this.logger=g.createLogger("Longo."+this.db.name+"."+this.name,e.LOGLEVEL),this.cbs={"-1":function(a){d.logger.error(["Error:Failed to detect specified callback.","If you want to handle this error with your own listener,","Use `db.collection('name').setDefaultErrorHandler(listner);`"].join(""),a)}},this.observers={};var i=this.worker=new Worker(e.getRoot()+"/"+e.WORKERJS);i.addEventListener("message",this.onMessage(),!1),i.addEventListener("error",this.onError(),!1),this.status=f.STARTED};g.inherits(j,h),j.prototype.setDefaultErrorHandler=function(a){this.cbs[-1]=a},j.prototype.onMessage=function(){var a=this;return function(b){var d,f,h,i,j;return a.logger.info("Response Received"),d=g.tryParseJSON(g.ab2str(b.data)),g.existy(d[0])?(i=c(d[0]),a.db.lastError=i,a.db.emit("error",i),a.emit("error",i),a.logger.error("ERROR:Failed to parse WebWorker message",e.ErrorCds[i.code])):(f=d[1]||{},h=f.seq||"-1",j=f.result,g.existy(f.error)&&(i=c(f.error),a.db.lastError=i,a.db.emit("error",i),a.emit("error",i),a.logger.error("ERROR:Failed at worker",i)),f.isUpdated&&(_.each(_.values(a.observers),function(b){a.send(b.message,b.func,!1)}),a.emit("updated")),a.logger.info("Trigger callback: ",a.name+":"+h),void g.doWhen(_.isFunction(a.cbs[h]),a.cbs[h],[null,j]))}},j.prototype.onError=function(){var a=this;return function(b){return g.existy(b.code)||(b.code=e.Error.WEBWORKER_ERROR),a.db.lastError=b,a.db.emit("error",b),a.emit("error",b),a.logger.error(["Error:WebWorker Error!  Line ",b.lineno," in ",b.filename,": ",b.message].join("")),a.cbs[-1](b)}},j.prototype.isCapped=function(){return this.option.capped},j.prototype.initialize=function(a){var b=g.checkOrElse(a,[],_.isArray),c={cmds:[{cmd:"start",name:this.name,option:this.option,dataset:b}]};this.send(c)},j.prototype.getNextSeq=function(){var a=0,b=function(){return a++,a+""};return this.getNextSeq=b,a+""},j.prototype.send=function(a,b,c){var d,h,i,j,k;return h=g.checkOrElse(b,g.noop,_.isFunction),this.status!==f.STARTED?h(e.Error.COLLECTION_NOT_STARTED,null):(d=this.getNextSeq(),this.cbs[d]=h,a.seq=d,this.option.storeFunction,i=JSON.stringify(a),j=g.str2ab(i),this.worker.postMessage(j,[j.buffer]),this.logger.info("New operation called: "+this.name+":"+d),c&&(this.observers[d]={message:a,func:h},this.logger.info("New observer registerd: "+this.name+":"+d)),k=this.name+":"+d,this.db.currentOpId=k,k)},j.prototype.find=function(a,b){var c=[{cmd:"find",criteria:a},{cmd:"project",projection:b}];return new k(this,c)},j.prototype.findOne=function(a,b){var c=[{cmd:"find",criteria:a},{cmd:"project",projection:b},{cmd:"limit",value:1}];return new k(this,c)},j.prototype.aggregate=function(a){var b,c=new k(this,[]);return _.each(a,function(a){switch(b=_.keys(a)[0]){case"$project":c=c.project(a[b]);break;case"$match":c=c.match(a[b]);break;case"$skip":c=c.skip(a[b]);break;case"$unwind":c=c.unwind(a[b]);break;case"$group":c=c.group(a[b]);break;case"$sort":c=c.sort(a[b])}}),c},j.prototype.save=function(a){var b={cmd:"save",doc:a};return new k(this,b)},j.prototype.insert=function(a){var b={cmd:"insert",doc:g.toArray(a)};return new k(this,b)},j.prototype.remove=function(a,b){var c={cmd:"remove",criteria:a,justOne:b};return new k(this,c)},j.prototype.update=function(a,b,c){var d={cmd:"update",criteria:a,update:b,option:c};return new k(this,d)},j.prototype.drop=function(){this.emit("drop"),this.worker.terminate(),this.cbs={},this.observers={},delete this.db.collections[this.name],localStorage.setItem("Longo:"+this.db.name+":"+this.name,[])},j.prototype.count=function(){var a=[{cmd:"find",criteria:{}},{cmd:"count"}];return new k(this,a)},j.prototype.findAndModify=function(){},j.prototype.parsist=function(){var a=this;this.find({}).onValue(function(b,c){localStorage.setItem("Longo:"+a.db.name+":"+a.name,JSON.stringify(c))})},j.prototype.copyTo=function(){},j.prototype.dataSize=function(){},j.prototype.copyTo=function(){},j.prototype.distinct=function(){},j.prototype.group=function(){},j.prototype.mapReduce=function(){},j.prototype.renameCollection=function(a){this.db.collections[a]=this,delete this.db.collections[this.name],this.name=a,this.logger=g.createLogger("Longo."+this.db.name+"."+this.name,e.LOGLEVEL)};var k=e.Cursor=function(){var a=g.aSlice(arguments);a[0]instanceof k?(this.collection=a[0].collection,this.cmds=a[0].cmds,this.wrapCb=a[0].wrapCb,this.cmds.push(g.getOrElse(a[1],{})),_.isFunction(a[2])&&this.wrapCb.push(a[2])):(this.collection=a[0],this.cmds=g.toArray(a[1]),this.wrapCb=g.toArray(g.getOrElse(a[2],g.noop)))};k.prototype.done=function(a){var b,c,d,e=g.checkOrElse(a,g.noop,_.isFunction);return b=this,c={cmds:this.cmds},d=function(){var a=g.aSlice(arguments);_.invoke(b.wrapCb,"call"),e.apply(null,a)},this.collection.send(c,d)},k.prototype.onValue=function(a,b){if(_.some([_.contains(_.keys(this.cmds),"save"),_.contains(_.keys(this.cmds),"insert"),_.contains(_.keys(this.cmds),"remove"),_.contains(_.keys(this.cmds),"update"),_.contains(_.keys(this.cmds),"drop")]))return this.collection.logger.warn("WARN:`onValue` is not supported for 'save','insert','remove','update','drop'. call `done` instead."),this.done(a);var c,d,e,f=g.checkOrElse(a,g.noop,_.isFunction);return c=this,d={cmds:this.cmds},e=function(){var a=null;return function(){var d=g.aSlice(arguments);_.invoke(c.wrapCb,"call");var e=JSON.stringify(d[1]);b&&_.isEqual(a,e)||(a=e,f.apply(null,d))}}(),this.collection.send(d,e,!0)},k.prototype.assign=function(a,b){var c,d;return _.isFunction(a.html)?d=function(c,d){c&&this.collection.logger.error("Error:Assign Result Error"),console.log(d),a.html(b({result:d}))}:(c=document.querySelector(a),d=function(a,d){a&&this.collection.logger.error("Error:Assign Result Error"),c.innerHTML=b({result:d})}),this.onValue(d,!0)},k.prototype.count=function(){var a={cmd:"count"};return new k(this,a)},k.prototype.forEach=function(a){var b={cmd:"forEach",func:"return "+a.toString()+";"};return new k(this,b)},k.prototype.limit=function(a){var b={cmd:"limit",value:a};return new k(this,b)},k.prototype.map=function(a){var b={cmd:"map",func:"return "+a.toString()+";"};return new k(this,b)},k.prototype.max=function(a){var b={cmd:"max",indexBounds:a||{}};return new k(this,b)},k.prototype.min=function(a){var b={cmd:"min",indexBounds:a||{}};return new k(this,b)},k.prototype.size=function(){var a={cmd:"size"};return new k(this,a)},k.prototype.skip=function(a){var b={cmd:"skip",value:a};return new k(this,b)},k.prototype.sort=function(a){var b={cmd:"sort",sorter:a};return _.isFunction(a)&&(b.func="return "+a.toString()+";"),new k(this,b)},k.prototype.match=function(a){var b={cmd:"find",criteria:a};return new k(this,b)},k.prototype.project=function(a){var b={cmd:"project",projection:a};return new k(this,b)},k.prototype.unwind=function(a){var b={cmd:"unwind",projection:a};return new k(this,b)},k.prototype.group=function(a){var b={cmd:"group",grouping:a};return new k(this,b)},e.getVersion=function(){return e.VERSION},e.setRoot=function(a){if(_.isUndefined(a)||a instanceof d.Event){a="/Longo.js";for(var b=d.document.getElementsByTagName("script"),c=b.length;c--;){var f=b[c].src.match(/(^|.*)\/longo(\.min){0,}\.js$/);if(f){a=f[1],f[2]&&(e.WORKERJS="longoWorker.min.js");break}}}e.LONGOROOT!==a&&console.info("LONGOROOT is setted :"+a),e.LONGOROOT=a},d.addEventListener("load",e.setRoot,!1),e.getRoot=function(){return e.LONGOROOT},e.useMinified=function(){e.WORKERJS="longoWorker.min.js"},e.setLogLevel=function(a){e.LOGLEVEL=a},e.createDB=function(){var a={};return function(b){var c,d=g.getOrElse(b,"temp")+"";return _.has(a,d)?a[d]:(c=new i(d),a[d]=c,c)}}(),e.use=e.createDB,a.Longo=e}(this);
//# sourceMappingURL=longo.min.map