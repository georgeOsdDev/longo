/*
 * longo v-0.1.0
 * Source code can be found at https://github.com/georgeosddev/longo
 *
 * license   The MIT License (MIT)
 * copyright Copyright (c) 2014 Takeharu Oshida <georgeosddev@gmail.com>
 */

!function(a,b){"use strict";var c=a,d=a.Longo={};d.VERSION="0.1.0",d.LONGOROOT="/Longo.js",d.WORKERJS="longoWorker.js",d.LOGLEVEL="warn";var e=d.Status={CREATED:0,STARTED:1,STOPPED:2,DELETED:3};d.Error=function(a,b,c){this.code=a,this.message=b,this.stack=c||(new Error).stack},d.Error.UNEXPECTED_ERROR=1,d.Error.EXECUTION_ERROR=2,d.Error.WEBWORKER_ERROR=3,d.Error.INVALID_QUERY=4,d.Error.COLLECTION_NOT_FOUND=5,d.Error.COLLECTION_ALREADY_EXISTS=6,d.Error.COLLECTION_NOT_STARTED=7,d.Error.DUPLICATE_KEY_ERROR=8,d.Error.DOCUMENT_NOT_FOUND=9,d.Error.MOD_ID_NOT_ALLOWED=10,d.Error.NOT_SUPPOETRD=11,d.Error.EVAL_ERROR=12,d.Error.INVALID_MODIFIER_SPECIFIED=13,d.ErrorCds=_.invert(d.Error);var f=d.Utils={ab2str:function(b){return String.fromCharCode.apply(null,new a.Uint16Array(b))},str2ab:function(b){for(var c=new a.ArrayBuffer(2*b.length),d=new a.Uint16Array(c),e=0,f=b.length;f>e;e++)d[e]=b.charCodeAt(e);return d},inherits:function(a,b){a._super=b,a.prototype=Object.create(b.prototype,{constructor:{value:a,enumerable:!1,writable:!0,configurable:!0}})},createLogger:function(a,b){var d={log:4,debug:3,info:2,warn:1,error:0},e={log:function(){},debug:function(){},info:function(){},warn:function(){},error:function(){}},f=d[b+"".toLowerCase()]||5;return c.console?(f>3&&(e.log=function(){return c.console.log.bind(c.console,a)}()),f>2&&(e.debug=function(){return c.console.debug.bind(c.console,a)}()),f>1&&(e.info=function(){return c.console.info.bind(c.console,a)}()),f>0&&(e.warn=function(){return c.console.warn.bind(c.console,a)}()),e.error=function(){return c.console.error.bind(c.console,a)}(),e):e},noop:function(){return void 0},asNoop:function(){return f.noop},aSlice:function(a){return Array.prototype.slice.apply(a)},toArray:function(a){return _.isArray(a)?a:[a]},existy:function(a){return null!==a&&a!==b},truthy:function(a){return a!==!1&&f.existy(a)},isTrue:function(a){return a===!0},isFalse:function(a){return a===!1},isNegativeNum:function(a){return _.isNumber(a)&&0>a},isZero:function(a){return 0===a},isOne:function(a){return 1===a},isPositiveNum:function(a){return _.isNumber(a)&&a>0},doWhen:function(a,b,c,d){var e=f.toArray(c);return f.truthy(a)?b.apply(d,e):f.noop()},doWhenOrElse:function(a,b,c,d,e){var g=f.toArray(d);return f.truthy(a)?b.apply(e,g):c.apply(e,g)},getOrElse:function(a,b){return f.existy(a)?a:b},checkOrElse:function(a,b,c){return f.truthy(c(a))?a:b},tryParseJSON:function(a){var b=[null,null];try{b[1]=JSON.parse(a)}catch(c){b[0]=new d.Error(Error.PARSE_ERROR,"Failed to parse: "+a,c.stack)}return b},dataFromId:function(a){return new Date(Number(a.substr(0,13)))}};f.inherits(d.Error,Error);var g=d.EventEmitter;c.EventEmitter?g=c.EventEmitter:(g=function(){this.dom=c.document.createDocumentFragment()},g.prototype.addEventListener=function(){this.dom.addEventListener.apply(this.dom,d.Utils.aSlice(arguments))},g.prototype.removeEventListener=function(){this.dom.removeEventListener.apply(this.dom,d.Utils.aSlice(arguments))},g.prototype.dispatchEvent=function(){var b=d.Utils.aSlice(arguments),c=b[0];if(c){if("Event"!==c.constructor.name){var e=new a.CustomEvent(b[0].toString(),b[1]);e.data=b.slice(1),b[0]=e}this.dom.dispatchEvent.apply(this.dom,b)}},g.prototype.on=g.prototype.addEventListener,g.prototype.bind=g.prototype.addEventListener,g.prototype.off=g.prototype.removeEventListener,g.prototype.unbind=g.prototype.removeEventListener,g.prototype.emit=g.prototype.dispatchEvent,g.prototype.trigger=g.prototype.dispatchEvent,c.console&&c.console.warn&&c.console.warn(["[WARN]:EventEmitter is not imported.","Longo use dom based EventEmitter by default.","For better performance, please use Wolfy87's EventEmitter implementation.","https://github.com/Wolfy87/EventEmitter"].join(" ")));var h=function(a){g.call(this),this.name=a,this.lastError=null,this.collections={},this.logger=d.Utils.createLogger("Longo."+a,d.LOGLEVEL)};d.Utils.inherits(h,g),h.prototype.getCollectionNames=function(){return _.keys(this.collections)},h.prototype.getCollection=function(a){return this.collections[a]},h.prototype.collection=function(a){var b,c,d;return b=f.getOrElse(a,"temp")+"",this.collections[b]?this.collections[b]:(c=JSON.parse(localStorage.getItem("Longo:"+this.name+":"+b)),d=f.toArray(f.getOrElse(c,[])),this.createCollection(a,{},d))},h.prototype.createCollection=function(a,b,c){var d=f.getOrElse(a,"temp")+"",e=new i(d,b,this);return e.initialize(c),this.collections[d]=e,e},h.prototype.dropDatabase=function(){_.each(_.values(this.collections),function(a){a.drop().done()})},h.prototype.getLastError=function(){return this.lastError},h.prototype.cloneCollection=function(a,b,c,e){var g=f.getOrElse(b,"temp")+"";if(!this.collections[g])return e(d.Error.COLLECTION_ALREADY_EXISTS,null);if(!this.collections[a])return e(null,this.createCollection(g));var h=function(a,c){return a?e(a,null):e(null,this.createCollection(b,{},c))};this.collection(a).find(c,{}).done(h)},h.prototype.killOp=function(a){var b=a.split[":"];this.collections[b[0]]&&(delete this.collections[b[0]].cbs[[1]],delete this.collections[b[0]].observers[[1]])};var i=function(a,b,c){g.call(this);var h=this;this.name=a,this.option={capped:b.capped||!1,size:b.size||1048576,count:b.count||1e3},this.db=c,this.logger=f.createLogger("Longo."+this.db.name+"."+this.name,d.LOGLEVEL),this.cbs={"-1":function(a){h.logger.error(["Error:Failed to detect specified callback.","If you want to handle this error with your own listener,","Use `db.collection('name').setDefaultErrorHandler(listner);`"].join(""),a)}},this.observers={};var i=this.worker=new Worker(d.LONGOROOT+"/"+d.WORKERJS);i.addEventListener("message",this.onMessage(),!1),i.addEventListener("error",this.onError(),!1),this.status=e.STARTED};f.inherits(i,g),i.prototype.setDefaultErrorHandler=function(a){this.cbs[-1]=a},i.prototype.onMessage=function(){var a=this;return function(b){var c,e,g,h,i;return a.logger.info("Response Received"),c=f.tryParseJSON(f.ab2str(b.data)),c[0]?(a.db.lastError=c[0],a.db.emit("error",c[0]),a.emit("error",c[0]),a.logger.error("ERROR:Failed to parse WebWorker message",d.ErrorCds[c[0]])):(e=c[1]||{},g=e.seq||"-1",h=e.error||null,i=e.result,h&&(a.db.lastError=h,a.db.emit("error",h),a.emit("error",h),a.logger.error("ERROR:Failed at worker",h)),e.isUpdated&&(_.each(_.values(a.observers),function(b){a.send(b.message,b.func,!1)}),a.emit("updated")),a.logger.info("Trigger callback: ",a.name+":"+g),void f.doWhen(_.isFunction(a.cbs[g]),a.cbs[g],[h,i]))}},i.prototype.onError=function(){var a=this;return function(b){return a.db.lastError=b,a.db.emit("error",b),a.emit("error",b),a.logger.error(["Error:Unexpected error!  Line ",b.lineno," in ",b.filename,": ",b.message].join("")),a.cbs[-1](b)}},i.prototype.isCapped=function(){return this.option.capped},i.prototype.initialize=function(a){var b=f.checkOrElse(a,[],_.isArray),c={cmds:[{cmd:"start",name:this.name,option:this.option,dataset:b}]};this.send(c)},i.prototype.getNextSeq=function(){var a=0,b=function(){return a++,a+""};return this.getNextSeq=b,a+""},i.prototype.send=function(a,b,c){var g,h,i,j;return h=f.checkOrElse(b,f.noop,_.isFunction),this.status!==e.STARTED?h(d.Error.COLLECTION_NOT_STARTED,null):(g=this.getNextSeq(),this.cbs[g]=h,a.seq=g,i=JSON.stringify(a),j=f.str2ab(i),this.worker.postMessage(j,[j.buffer]),this.logger.info("New operation called: "+this.name+":"+g),c&&(this.observers[g]={message:a,func:h},this.logger.info("New observer registerd: "+this.name+":"+g)),this.name+":"+g)},i.prototype.find=function(a,b){var c=[{cmd:"find",criteria:a},{cmd:"project",projection:b}];return new j(this,c)},i.prototype.findOne=function(a,b){var c=[{cmd:"find",criteria:a},{cmd:"project",projection:b},{cmd:"limit",value:1}];return new j(this,c)},i.prototype.aggregate=function(a){var b,c=new j(this,[]);return _.each(a,function(a){switch(b=_.keys(a)[0]){case"$project":c=c.project(a[b]);break;case"$match":c=c.match(a[b]);break;case"$skip":c=c.skip(a[b]);break;case"$unwind":c=c.unwind(a[b]);break;case"$group":c=c.group(a[b]);break;case"$sort":c=c.sort(a[b])}}),c},i.prototype.save=function(a){var b={cmd:"save",doc:a};return new j(this,b)},i.prototype.insert=function(a){var b={cmd:"insert",doc:f.toArray(a)};return new j(this,b)},i.prototype.remove=function(a,b){var c={cmd:"remove",criteria:a,justOne:b};return new j(this,c)},i.prototype.update=function(a,b,c){var d={cmd:"update",criteria:a,update:b,option:c};return new j(this,d)},i.prototype.drop=function(){this.emit("drop"),this.worker.terminate(),this.cbs={},this.observers={},delete this.db.collections[this.name]},i.prototype.count=function(){var a=[{cmd:"find",criteria:{}},{cmd:"count"}];return new j(this,a)},i.prototype.findAndModify=function(){},i.prototype.parsist=function(){var a=this;this.find({}).onValue(function(b,c){localStorage.setItem("Longo:"+a.db.name+":"+a.name,JSON.stringify(c))})},i.prototype.copyTo=function(){},i.prototype.dataSize=function(){},i.prototype.copyTo=function(){},i.prototype.distinct=function(){},i.prototype.group=function(){},i.prototype.mapReduce=function(){},i.prototype.renameCollection=function(a){this.db.collections[a]=this,delete this.db.collections[this.name],this.name=a,this.logger=f.createLogger("Longo."+this.db.name+"."+this.name,d.LOGLEVEL)};var j=d.Cursor=function(){var a=f.aSlice(arguments);a[0]instanceof j?(this.collection=a[0].collection,this.cmds=a[0].cmds,this.wrapCb=a[0].wrapCb,this.cmds.push(f.getOrElse(a[1],{})),_.isFunction(a[2])&&this.wrapCb.push(a[2])):(this.collection=a[0],this.cmds=f.toArray(a[1]),this.wrapCb=f.toArray(f.getOrElse(a[2],f.noop)))};j.prototype.done=function(a){var b,c,d,e=f.checkOrElse(a,f.noop,_.isFunction);return b=this,c={cmds:this.cmds},d=function(){var a=f.aSlice(arguments);_.invoke(b.wrapCb,"call"),e.apply(null,a)},this.collection.send(c,d)},j.prototype.onValue=function(a,b){if(_.some([_.contains(_.keys(this.cmds),"save"),_.contains(_.keys(this.cmds),"insert"),_.contains(_.keys(this.cmds),"remove"),_.contains(_.keys(this.cmds),"update"),_.contains(_.keys(this.cmds),"drop")]))return this.collection.logger.warn("WARN:`onValue` is not supported for 'save','insert','remove','update','drop'. call `done` instead."),this.done(a);var c,d,e,g=f.checkOrElse(a,f.noop,_.isFunction);return c=this,d={cmds:this.cmds},e=function(){var a=null;return function(){var d=f.aSlice(arguments);_.invoke(c.wrapCb,"call");var e=JSON.stringify(d[1]);b&&_.isEqual(a,e)||(a=e,g.apply(null,d))}}(),this.collection.send(d,e,!0)},j.prototype.count=function(){var a={cmd:"count"};return new j(this,a)},j.prototype.forEach=function(a){var b={cmd:"forEach",func:"return "+a.toString()+";"};return new j(this,b)},j.prototype.limit=function(a){var b={cmd:"limit",value:a};return new j(this,b)},j.prototype.map=function(a){var b={cmd:"map",func:"return "+a.toString()+";"};return new j(this,b)},j.prototype.max=function(a){var b={cmd:"max",indexBounds:a||{}};return new j(this,b)},j.prototype.min=function(a){var b={cmd:"min",indexBounds:a||{}};return new j(this,b)},j.prototype.size=function(){var a={cmd:"size"};return new j(this,a)},j.prototype.skip=function(a){var b={cmd:"skip",value:a};return new j(this,b)},j.prototype.sort=function(a){var b={cmd:"sort",sorter:a};return _.isFunction(a)&&(b.func="return "+a.toString()+";"),new j(this,b)},j.prototype.match=function(a){var b={cmd:"find",criteria:a};return new j(this,b)},j.prototype.project=function(a){var b={cmd:"project",projection:a};return new j(this,b)},j.prototype.unwind=function(a){var b={cmd:"unwind",projection:a};return new j(this,b)},j.prototype.group=function(a){var b={cmd:"group",grouping:a};return new j(this,b)},d.getVersion=function(){return d.VERSION},d.setRoot=function(a){if(_.isUndefined(a)||a instanceof c.Event){a="/Longo.js";for(var b=c.document.getElementsByTagName("script"),e=b.length;e--;){var f=b[e].src.match(/(^|.*)\/longo(\.min){0,}\.js$/);if(f){a=f[1],f[2]&&(d.WORKERJS="longoWorker.min.js");break}}}d.LONGOROOT!==a&&console.info("LONGOROOT is setted :"+a),d.LONGOROOT=a},c.addEventListener("load",d.setRoot,!1),d.useMinified=function(){d.WORKERJS="longoWorker.min.js"},d.setLogLevel=function(a){d.LOGLEVEL=a},d.createDB=function(){var a={};return function(b){var c;return _.has(a,b)?a[b]:(c=new h(b),a[b]=c,c)}}(),d.use=d.createDB,a.Longo=d}(this);
//# sourceMappingURL=longo.min.map